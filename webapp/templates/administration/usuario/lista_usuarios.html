{% extends "base.html" %}
{% load static form_filters %}
{% block title %}Lista de Usuarios{% endblock %}
{% block content %}

{% if messages %}
  {% for message in messages %}
    <div class="alert alert-{{ message.tags }} mt-2">{{ message }}</div>
  {% endfor %}
{% endif %}

<h1>Lista de Usuarios</h1>

<!-- Botón para abrir modal de creación -->
<div class="d-flex justify-content-between mb-3">
<button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#usuarioModal">
  Nuevo Usuario
</button>
<a href="{% url 'administracion' %}" class="btn btn-success">
  ← Volver a Administración
</a>
</div>
<!-- Modal de creación -->
<div class="modal fade" id="usuarioModal" tabindex="-1" aria-labelledby="usuarioModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form method="post" action="{% url 'usuario_create' %}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="usuarioModalLabel">Crear Usuario</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6">
              <h4>Datos de Usuario</h4>
              <div class="mb-3">
                <label for="{{ user_form.username.id_for_label }}">Usuario</label>
                {{ user_form.username }}
              </div>
              <div class="mb-3">
                <label for="{{ user_form.email.id_for_label }}">Correo</label>
                {{ user_form.email }}
              </div>
              <div class="mb-3">
                <label for="{{ user_form.first_name.id_for_label }}">Nombre</label>
                {{ user_form.first_name }}
              </div>
              <div class="mb-3">
                <label for="{{ user_form.last_name.id_for_label }}">Apellido</label>
                {{ user_form.last_name }}
              </div>
              <div class="mb-3">
                <label for="{{ user_form.password.id_for_label }}">Contraseña</label>
                <div class="input-group">
                  {{ user_form.password }}
                  <button type="button" class="btn btn-outline-secondary" id="togglePassword">
                    <i class="bi bi-eye" id="icon-eye"></i>
                  </button>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <h4>Perfil</h4>
              {{ perfil_form.as_p }}
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Guardar</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<ul class="list-group">
    {% for usuario in usuarios %}
        <li class="list-group-item d-flex justify-content-between align-items-center">
            <span>
                {{ usuario.user.username }} ({{ usuario.empresa.nombre }})
            </span>
            <span>
                <button type="button" class="btn btn-sm btn-primary me-2" data-bs-toggle="modal" data-bs-target="#editarUsuarioModal{{ usuario.pk }}">
                    Editar
                </button>
                <button type="button" class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#deleteUsuarioModal{{ usuario.pk }}">
                  Eliminar
                </button>
            </span>
        </li>

        <!-- Modal de edición -->
        <div class="modal fade" id="editarUsuarioModal{{ usuario.pk }}" tabindex="-1" aria-labelledby="editarUsuarioModalLabel{{ usuario.pk }}" aria-hidden="true">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <form method="post" action="{% url 'usuario_update' usuario.pk %}">
                {% csrf_token %}
                <div class="modal-header">
                  <h5 class="modal-title" id="editarUsuarioModalLabel{{ usuario.pk }}">Editar Usuario</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                  <div class="row">
                    <div class="col-md-6">
                      <h4>Datos de Usuario</h4>
                      {{ edit_forms|dict_get:usuario.pk|dict_get:"user_form"|as_p }}
                    </div>
                    <div class="col-md-6">
                      <h4>Perfil</h4>
                      {{ edit_forms|dict_get:usuario.pk|dict_get:"perfil_form"|as_p }}
                    </div>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="submit" class="btn btn-primary">Guardar</button>
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <!-- Modal de confirmación de eliminación -->
        <div class="modal fade" id="deleteUsuarioModal{{ usuario.pk }}" tabindex="-1" aria-labelledby="deleteUsuarioModalLabel{{ usuario.pk }}" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <form method="post" action="{% url 'usuario_delete' usuario.pk %}">
                {% csrf_token %}
                <div class="modal-header">
                  <h5 class="modal-title" id="deleteUsuarioModalLabel{{ usuario.pk }}">Eliminar Usuario</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                  <p>¿Estás seguro de que deseas eliminar al usuario <strong>{{ usuario.user.username }}</strong>?</p>
                </div>
                <div class="modal-footer">
                  <button type="submit" class="btn btn-danger">Eliminar</button>
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                </div>
              </form>
            </div>
          </div>
        </div>
    {% endfor %}
</ul>
{% if abrir_modal %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    var myModal = new bootstrap.Modal(document.getElementById('usuarioModal'));
    myModal.show();
  });
</script>
{% endif %}

<script>
  document.addEventListener('DOMContentLoaded', function() {
    var toggle = document.getElementById('togglePassword');
    var passwordInput = document.getElementById('id_password');
    var icon = document.getElementById('icon-eye');
    if (toggle && passwordInput && icon) {
      toggle.addEventListener('click', function() {
        if (passwordInput.type === 'password') {
          passwordInput.type = 'text';
          icon.classList.remove('bi-eye');
          icon.classList.add('bi-eye-slash');
        } else {
          passwordInput.type = 'password';
          icon.classList.remove('bi-eye-slash');
          icon.classList.add('bi-eye');
        }
      });
    }
  });
</script>

{% endblock %}